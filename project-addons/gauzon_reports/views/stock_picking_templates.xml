<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="valued_report_picking_custom" inherit_id="stock_picking_report_valued.valued_report_picking">
        <xpath expr="//t[@t-if='o.valued and o.sale_id and o.move_line_ids']/th[last()]" position="attributes">
            <attribute name="t-if">not for_customs</attribute>
        </xpath>
        <xpath expr="//span[@t-field='move_line.sale_tax_description']/.." position="attributes">
             <attribute name="t-if">not for_customs</attribute>
        </xpath>
        <xpath expr="//table[hasclass('mt32')]//th[2]" position="attributes">
            <attribute name="t-if">not for_customs</attribute>
        </xpath>
        <xpath expr="//table[hasclass('mt32')]//th[3]" position="attributes">
            <attribute name="t-if">not for_customs</attribute>
        </xpath>
        <xpath expr="//table[hasclass('mt32')]//th" position="before">
            <th t-if="not for_customs" class="text-right"><strong>Gross Amount:</strong></th>
            <th t-if="not for_customs" class="text-right"><strong>Discounted:</strong></th>
        </xpath>
        <xpath expr="//table[hasclass('mt32')]//td[2]" position="attributes">
            <attribute name="t-if">not for_customs</attribute>
        </xpath>
        <xpath expr="//table[hasclass('mt32')]//td[3]" position="attributes">
            <attribute name="t-if">not for_customs</attribute>
        </xpath>
        <xpath expr="//table[hasclass('mt32')]//td" position="before">
            <td t-if="not for_customs" class="text-right"><span t-field="o.amount_gross"></span></td>
            <td t-if="not for_customs" class="text-right"><span t-field="o.amount_discounted"></span></td>
        </xpath>
        <xpath expr="//span[@t-field='move_line.sale_price_unit']" position="attributes">
            <attribute name="t-if">o.sale_id</attribute>
        </xpath>
        <xpath expr="//span[@t-field='move_line.sale_price_unit']" position="after">
            <span t-field="move_line.product_id.standard_price" t-if="for_customs and o.picking_type_code == 'outgoing' and not o.sale_id"/>
        </xpath>
        <xpath expr="//span[@t-field='move_line.sale_price_subtotal']" position="attributes">
            <attribute name="t-if">o.sale_id</attribute>
        </xpath>
        <xpath expr="//span[@t-field='move_line.sale_price_subtotal']" position="after">
            <span t-esc="move_line.product_id.standard_price * move_line.product_uom_qty" t-if="for_customs and o.picking_type_code == 'outgoing' and not o.sale_id and o.state != 'done'"/>
            <span t-esc="move_line.product_id.standard_price * move_line.qty_done" t-if="for_customs and o.picking_type_code == 'outgoing' and not o.sale_id and o.state == 'done'"/>
        </xpath>
        <xpath expr="//span[@t-field='o.amount_untaxed']" position="attributes">
            <attribute name="t-if">o.sale_id</attribute>
        </xpath>
        <xpath expr="//span[@t-field='o.amount_untaxed']" position="after">
            <span t-esc="sum([move_line.product_id.standard_price * move_line.product_uom_qty for move_line in o.move_line_ids])" t-if="for_customs and o.picking_type_code == 'outgoing' and not o.sale_id and o.state != 'done'"/>
            <span t-esc="sum([move_line.product_id.standard_price * move_line.qty_done for move_line in o.move_line_ids])" t-if="for_customs and o.picking_type_code == 'outgoing' and not o.sale_id and o.state == 'done'"/>
        </xpath>
        <xpath expr="//t[@t-if='o.valued and o.sale_id and o.move_line_ids'][1]" position="attributes">
            <attribute name="t-if">o.valued and (o.sale_id or o.picking_type_code == 'outgoing') and o.move_line_ids</attribute>
        </xpath>
        <xpath expr="//t[@t-if='o.valued and o.sale_id and o.move_line_ids'][1]" position="attributes">
            <attribute name="t-if">o.valued and (o.sale_id or o.picking_type_code == 'outgoing') and o.move_line_ids</attribute>
        </xpath>
        <xpath expr="//t[@t-if='o.valued and o.sale_id and o.move_line_ids'][1]" position="attributes">
            <attribute name="t-if">o.valued and (o.sale_id or o.picking_type_code == 'outgoing') and o.move_line_ids</attribute>
        </xpath>
    </template>

    <template id="report_delivery_document_custom" inherit_id="sale_stock.report_delivery_document_inherit_sale_stock">
        <xpath expr="//t[@t-set='o']" position="after">
            <t t-set="title">
                <strong t-if="not for_customs" style="font-size: 110%;">PICKING / RECEIPT PICKING</strong>
                <strong t-if="not for_customs"><br/><span style="font-size: 130%;"><span t-field="o.name"/></span></strong>
                <strong t-if="for_customs" style="font-size: 110%;">INVOICE FOR CUSTOMS PURPOSE ONLY</strong>
            </t>
            <t t-set="left_box">
                <t t-if="o.picking_type_id.code=='outgoing'">
                    Customer:<br/>
                </t>
                <t t-if="o.picking_type_id.code=='incoming'">
                    Supplier:<br/>
                </t>
                <div t-field="o.partner_id"
                    t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                <span t-if="o.partner_id.vat" t-field="o.partner_id.vat"></span>
            </t>
            <t t-set="right_box">
                <div class="row mt2">
                    <div class="col-xs-3">
                      Date:
                    </div>
                    <div class="col-xs-9">
                      <span t-field="o.scheduled_date" t-options="{'widget': 'date'}"/>
                    </div>
                </div>
                <div class="row mt2" t-if="o.num_contract">
                    <div class="col-xs-3">
                      Your Ref.:
                    </div>
                    <div class="col-xs-9">
                      <span t-field="o.num_contract"/>
                    </div>
                </div>
                <div class="row mt2" t-if="o.origin">
                    <div class="col-xs-3">
                      Origin:
                    </div>
                    <div class="col-xs-9">
                      <span t-field="o.origin"/>
                    </div>
                </div>
                <div class="row mt2" t-if="o.carrier_id">
                    <div class="col-xs-3">
                      Freight:
                    </div>
                    <div class="col-xs-9">
                      <span t-field="o.carrier_id"/>
                    </div>
                </div>
                <div class="row mt2" t-if="o.sale_id.client_order_ref">
                    <div class="col-xs-3">
                     Reference:
                    </div>
                    <div class="col-xs-9">
                      <span t-field="o.sale_id.client_order_ref"/>
                    </div>
                </div>
                <div class="row mt2" t-if="for_customs">
                    <div class="col-xs-3">
                      Observations:
                    </div>
                    <div class="col-xs-9">
                      <span t-field="o.name"/>
                    </div>
                </div>

                
                <div class="row mt2" t-if="o.purchase_id.dest_address_id">
                    <div class="col-xs-3">
                      Entregar en:
                    </div>
                    <div class="col-xs-9">
                        <div t-field="o.purchase_id.dest_address_id"
                            t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
                    </div>
                </div>
            </t>
            <t t-set="watermark">
                <div class="watermark" style="width: 100%; position:fixed;opacity:0.25;top:500px;font-size:7em;text-align:center;z-index:1000;" t-if="o.state != 'done'">
                    <span>PENDING TO CONFIRM - NOT VALID FOR SUPPLY</span>
                </div>
            </t>
        </xpath>
        <xpath expr="//div[@name='customer_address']" position="replace"/>
        <xpath expr="//h2" position="replace"/>
        <xpath expr="//table" position="replace"/>
        <xpath expr="//div[@t-if='o.sudo().sale_id.client_order_ref']" position="replace"/>
        <xpath expr="//th" position="before">
            <th>Pos.</th>
            <th>Código</th>
        </xpath>
        <xpath expr="//span[@t-field='move.product_id']/.." position="replace">
            <td><span t-field="move.sequence" class="text-center"/></td>
            <td><span t-field="move.product_id.default_code"/></td>
            <td><span t-raw="move.name.replace('[' + move.product_id.default_code + ']', '').replace('\n', '&lt;br&gt;')"/></td>
        </xpath>
        <xpath expr="//span[@t-field='move.product_uom']" position="attributes">
            <attribute name="t-field">move.product_uom.edi_code</attribute>
        </xpath>
        <xpath expr="//th[@name='lot_serial']/../th[1]" position="before">
            <th>Pos.</th>
            <th>Código</th>
        </xpath>
        <xpath expr="//span[@t-field='move_line.product_id']/.." position="replace">
            <td><span t-field="move_line.move_id.sequence" class="text-center"/></td>
            <td><span t-field="move_line.product_id.default_code"/></td>
            <td><span t-esc="move_line.move_id.name.replace('[' + move_line.product_id.default_code + ']', '')"/></td>
        </xpath>
        <xpath expr="//span[@t-field='move_line.product_uom_id']" position="attributes">
            <attribute name="t-field">move_line.product_uom_id.edi_code</attribute>
        </xpath>
        <xpath expr="//p[@t-if='o.backorder_id']" position="replace">
            <div class="col-xs-12" t-if="o.note">
                <span>Notes:</span><br/>
                <span t-field="o.note"></span>
            </div>
        </xpath>
        <xpath expr="//p[last()]" position="replace"/>
        <xpath expr="//t[@t-set='lines']" position="attributes">
            <attribute name="t-value">only_done and o.move_lines.filtered(lambda x: x.quantity_done) or o.move_lines.filtered(lambda x: x.product_uom_qty)</attribute>
        </xpath>
        <xpath expr="//span[@t-field='move.product_uom_qty']" position="attributes">
            <attribute name="t-if">not only_done</attribute>
        </xpath>
        <xpath expr="//span[@t-field='move.product_uom_qty']" position="after">
            <span t-field="move.quantity_done" t-if="only_done"/>
        </xpath>
    </template>

    <template id="report_delivery_document_customs">
        <t t-call="web.html_container">
            <t t-set="for_customs" t-value="True"/>
            <t t-foreach="docs" t-as="o">
                <t t-call="stock.report_delivery_document" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>

    <template id="report_delivery_document_only_done">
        <t t-call="web.html_container">
            <t t-set="only_done" t-value="True"/>
            <t t-foreach="docs" t-as="o">
                <t t-call="stock.report_delivery_document" t-lang="o.partner_id.lang"/>
            </t>
        </t>
    </template>

</odoo>
