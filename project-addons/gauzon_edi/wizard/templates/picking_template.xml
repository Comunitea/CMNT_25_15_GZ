# -*- coding: utf-8 -*-
<%
    def get_operation(obj):
        operation_list = set()
        for op in obj.pack_operation_ids:
            if op.id:
                operation_list.add(op)
            else:
                operation_list.add(False)
        return operation_list

    def get_operation_lines(pack,obj):
        lines_list = []
        for op in obj.pack_operation_ids:
            if not pack:
                if not op.id:
                    lines_list.append(op)
            elif op.id and op.id == pack.id:
                lines_list.append(op)
        return lines_list

%>
        <?xml version="1.0" encoding="UTF-8"?>
<doc c="DESADV" gi_cab_nodo="351" gi_cab_funcion="9">

  <gi_cab>
    <gi_cab_numcontr>${ o.num_contract or '' }</gi_cab_numcontr>
    <gi_cab_numalb>${ o.name or '' }</gi_cab_numalb>
    <gi_cab_fecha>${ o.date.split(' ')[0] or '' }</gi_cab_fecha>
    <gi_cab_estimada_entrega>${ o.min_date.split(' ')[0] or ''  }</gi_cab_estimada_entrega>
    <gi_cab_emisor>${ o.company_id.partner_id.gln or '' }</gi_cab_emisor>
    <gi_cab_vendedor>${ o.company_id.partner_id.gln or '' }</gi_cab_vendedor>
    <gi_cab_comprador>${ o.partner_id.gln or '' }</gi_cab_comprador>
    <gi_cab_shipto>${ o.partner_id.gln or '' }</gi_cab_shipto>
  </gi_cab>

  <gi_empaqs>
    <% count = 1 %>
    %for x in get_operation(o):
    <gi_empaq n="${ count }" gi_empaq_tipo="${ x!=False and x.result_package_id and x.result_package_id.packaging_type_id.alias or ''}" gi_empaq_sscc="${ x!=False and x.result_package_id and x.result_package_id.name or ''}">
      <gi_lines><% count2 = 1 %>
        %for y in get_operation_lines(x,o):
        %for l in y.linked_move_operation_ids:
        <gi_lin n="${ count2 }">
          <gi_lin_numped>${ ((l.move_id.procurement_id) and (l.move_id.procurement_id.sale_line_id)) and l.move_id.procurement_id.sale_line_id.order_id.client_order_ref or ''}</gi_lin_numped>
          <gi_lin_ean13v>${ y.product_id.ean13v and y.product_id.ean13v or ''}</gi_lin_ean13v>
          <gi_lin_refcli>${ ((l.move_id.procurement_id) and (l.move_id.procurement_id.sale_line_id)) and l.move_id.procurement_id.sale_line_id.refcli or ''}</gi_lin_refcli>
          <gi_lin_refprov>${ ((l.move_id.procurement_id) and (l.move_id.procurement_id.sale_line_id)) and l.move_id.procurement_id.sale_line_id.refprov or ''}</gi_lin_refprov>
          <gi_lin_numserie>${ y.lot_id and y.lot_id.name or '' }</gi_lin_numserie>
          <gi_lin_descmer>${ ((l.move_id.procurement_id) and (l.move_id.procurement_id.sale_line_id)) and l.move_id.procurement_id.sale_line_id.name or ''}</gi_lin_descmer>
          <gi_lin_cantent gi_lin_umedida="${ y.product_uom_id and y.product_uom_id.edi_code or ''}">${ l.qty or '' }</gi_lin_cantent>
          <gi_lin_cantentfac gi_lin_umedfac="${ y.product_uom_id and y.product_uom_id.edi_code or ''}">${ l.qty  or '' }</gi_lin_cantentfac>
          <gi_lin_cantped gi_lin_umedida="${ y.product_uom_id and y.product_uom_id.edi_code or '' }">${ l.qty or '' }</gi_lin_cantped>
        </gi_lin><% count2 += 1 %>
        %endfor
        %endfor
      </gi_lines>
    </gi_empaq><% count += 1 %>
    %endfor
  </gi_empaqs>

</doc>
