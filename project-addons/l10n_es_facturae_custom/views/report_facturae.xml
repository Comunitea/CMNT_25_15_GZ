<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="template_facturae_edi" inherit_id="l10n_es_facturae.template_facturae">
        <xpath expr="//ReceiverContractReference" position="attributes">
            <attribute name="t-if">line.invoice_id.num_contract</attribute>
            <attribute name="t-esc">line.invoice_id.num_contract</attribute>
        </xpath>
        <xpath expr="//ReceiverTransactionReference" position="attributes">
            <attribute name="t-if">line.invoice_id.num_contract</attribute>
            <attribute name="t-esc">line.invoice_id.num_contract</attribute>
        </xpath>
        <xpath expr="//DeliveryNotesReferences" position="attributes">
            <attribute name="t-if">line.move_line_ids</attribute>
        </xpath>
        <xpath expr="//DeliveryNotesReferences" position="inside">
            <DeliveryNote>
                <DeliveryNoteNumber t-esc="line.move_line_ids[0].picking_id.name"/>
                <DeliveryNoteDate t-esc="line.move_line_ids[0].picking_id.date[:10]"/>
            </DeliveryNote>
        </xpath>
        <xpath expr="//InvoiceAdditionalInformation" position="attributes">
            <attribute name="t-esc">(invoice.fiscal_position_id.note and invoice.fiscal_position_id.note + '\n' or '') + (invoice.invoice_line_ids.mapped('move_line_ids.picking_id').filtered('note') and ('\n'.join([x.name + ': ' + x.note for x in invoice.invoice_line_ids.mapped('move_line_ids.picking_id').filtered('note')])) or '') + (invoice.comment or '')</attribute>
        </xpath>
        <xpath expr="//AdditionalData" position="attributes">
            <attribute name="t-if">invoice.fiscal_position_id.note or invoice.invoice_line_ids.mapped('move_line_ids.picking_id').filtered('note') or invoice.comment</attribute>
        </xpath>
        <xpath expr="//Invoice//TaxesOutputs/t/Tax/TaxableBase" position="replace">
            <TaxableBase>
                <TotalAmount t-esc="'%.2f' % round(tax_line.base, 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((tax_line.base * euro_rate / currency_rate), 2)"/>
            </TaxableBase>
        </xpath>
        <xpath expr="//Invoice//TaxesOutputs/t/Tax/TaxAmount" position="replace">
            <TaxAmount>
                <TotalAmount t-esc="'%.2f' % round(tax_line.amount, 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((tax_line.amount * euro_rate / currency_rate), 2)"/>
            </TaxAmount>
        </xpath>
        <xpath expr="//Invoice//TaxesWithheld/t/Tax/TaxableBase" position="replace">
            <TaxableBase>
                <TotalAmount t-esc="'%.2f' % round(tax_line.base, 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((tax_line.base * euro_rate / currency_rate), 2)"/>
            </TaxableBase>
        </xpath>
        <xpath expr="//Invoice//TaxesWithheld/t/Tax/TaxAmount" position="replace">
            <TaxAmount>
                <TotalAmount t-esc="'%.2f' % round(-tax_line.amount, 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((-tax_line.amount * euro_rate / currency_rate), 2)"/>
            </TaxAmount>
        </xpath>
        <xpath expr="//TotalTaxOutputs" position="attributes">
            <attribute name="t-esc">'%.2f' % round(amount_tax, 2)</attribute>
        </xpath>
        <xpath expr="//TotalTaxesWithheld" position="attributes">
            <attribute name="t-esc">'%.2f' % round(amount_tax_withheld, 2)</attribute>
        </xpath>
        <xpath expr="//Items//TaxesWithheld/t/Tax/TaxableBase" position="replace">
            <TaxableBase>
                <TotalAmount t-esc="'%.2f' % round(line.price_subtotal, 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((line.price_subtotal * euro_rate / currency_rate), 2)"/>
            </TaxableBase>
        </xpath>
        <xpath expr="//Items//TaxesWithheld/t/Tax/TaxAmount" position="replace">
            <TaxAmount>
                <TotalAmount t-esc="'%.2f' % round((line.price_subtotal * (-line_tax.amount)), 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((line.price_subtotal * (-line_tax.amount) * euro_rate / currency_rate), 2)"/>
            </TaxAmount>
        </xpath>
        <xpath expr="//Items//TaxesOutputs/t/Tax/TaxableBase" position="replace">
            <TaxableBase>
                <TotalAmount t-esc="'%.2f' % round(line.price_subtotal, 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((line.price_subtotal * euro_rate / currency_rate), 2)"/>
            </TaxableBase>
        </xpath>
        <xpath expr="//Items//TaxesOutputs/t/Tax/TaxAmount" position="replace">
            <TaxAmount>
                <TotalAmount t-esc="'%.2f' % round((line.price_subtotal * (line_tax.amount) / 100), 2)"/>
                <EquivalentInEuros t-esc="'%.2f' % round((line.price_subtotal * (line_tax.amount) / 100 * euro_rate / currency_rate), 2)"/>
            </TaxAmount>
        </xpath>
    </template>

    <template id="entity_commercial" inherit_id="l10n_es_facturae.entity">
        <xpath expr="//t[@t-set='buyer_type']" position="attributes">
            <attribute name="t-value">'J' if partner.commercial_partner_id.vat and partner.commercial_partner_id.is_company else 'F'</attribute>
        </xpath>
        <xpath expr="//LegalEntity/CorporateName" position="before">
            <t t-set="partner" t-value="partner.commercial_partner_id"/>
        </xpath>
    </template>

    <template id="administrative_center_fix" inherit_id="l10n_es_facturae.administrative_center">
        <xpath expr="//Name" position="attributes">
            <attribute name="t-if">False</attribute>
        </xpath>
        <xpath expr="//FirstSurname" position="attributes">
            <attribute name="t-if">False</attribute>
        </xpath>
    </template>

</odoo>
